//
var vm=new Vue({
    el:'#app',
    data:{
        //ä¸»é¡µé¢åˆ†ç±»è¡¨å•
        form:{
            system:'',
            activeId:'',
            countUnit:'',
            countDate:'',
            resqlimit:''
        },
        systemList:[],
        activeDictList:[],
        countUnitList:[],
        TPList:[],
        mycharts:'',
        TPText:'',
        option:{
            title : {
                text: 'è¶…å‡ºé˜ˆå€¼è®¿é—®é‡ç»Ÿè®¡ï¼ˆæ¬¡ï¼‰'
            },
            tooltip : {
                trigger: 'axis'
            },
            legend: {
                data:['æ€»è®¿é—®é‡','è¶…é˜ˆå€¼é‡']
            },
            toolbox: {
                show : true,
                feature : {
                    dataView : {show: true, readOnly: true},
                    magicType : {show: true, type: ['line', 'bar']},
                    restore : {show: true},
                    saveAsImage : {show: true}
                }
            },
            calculable : true,
            xAxis : [
                {
                    type : 'category',
                    data : ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ']
                }
            ],
            yAxis : [
                {
                    type : 'value'
                }
            ],
            series : [
                {
                    name:'æ€»è®¿é—®é‡',
                    type:'line',
                    data:[0, 0, 0 , 0, 0, 0],
                    markLine : {
                        data : [
                            {type : 'average', name: 'å¹³å‡å€¼'}
                        ]
                    }
                },
                {
                    name:'è¶…é˜ˆå€¼é‡',
                    type:'line',
                    data:[0, 0, 0 , 0, 0, 0],
                    markLine : {
                        data : [
                            {type : 'average', name: 'å¹³å‡å€¼'}
                        ]
                    }
                }
            ]
        },
        rules: {
            system: [
                { required: true, message: 'è¯·é€‰æ‹©ç³»ç»Ÿ', trigger: 'change' }
            ],
            countUnit: [
                { required: true, message: 'è¯·é€‰æ‹©ç»Ÿè®¡å•ä½', trigger: 'change' }
            ],
            countDate: [
                { required: true, message: 'è¯·é€‰æ‹©ç»Ÿè®¡å¼€å§‹æ—¥æ—¶', trigger: 'blur' }
            ],
            resqlimit: [
                { required: true, message: 'è¯·é€‰æ‹©ç»Ÿè®¡å¼€å§‹æ—¥æ—¶', trigger: 'blur' }
            ],
        },
    },

    methods:{
        getAllSystem:function(){
            this.$http.post('/star-web/systemController/findSystems',{

            }).then(
                function(data){
                    var b = data.body.hasErrors;
                    if (!b) {
                        this.systemList = data.body.data;
                    }else{
                        errorMessage = data.body.errorMessage;
                        this.$message({ showClose: true, message: errorMessage, type: 'failure', duration:2000 });
                    }
                },
                function(data){
                    this.$message({ showClose: true, message: 'ç³»ç»Ÿå¼‚å¸¸ï¼', type: 'failure', duration:2000 });
                });

        },
        //æ ¹æ®ç³»ç»Ÿé€‰æ‹©åŠ¨ä½œ
        getActionDictBySystem:function(){
            var loading = this.$loading({
                lock: true,
                text: 'ğŸ˜€æ‹¼å‘½åŠ è½½ä¸­ğŸ˜...',
                spinner: 'el-icon-loading',
                background: 'rgba(0, 0, 0, 0.7)'
            });
            this.$http.post('/star-web/activeDictController/findActiveDict',{
                system:this.form.system,
            }).then(
                function(data){
                    var b = data.body.hasErrors;
                    if (!b) {
                        this.activeDictList = data.body.data;
                    }else{
                        errorMessage = data.body.errorMessage;
                        this.$message({ showClose: true, message: errorMessage, type: 'failure', duration:2000 });
                    }
                    loading.close();
                },
                function(data){
                    loading.close();
                    this.$message({ showClose: true, message: 'è·å–åŠ¨ä½œé›†åˆå¤±è´¥ï¼', type: 'failure', duration:2000 });
                });

        },
        getCountUnit:function(){
            this.$http.post('/star-web/activeDictController/searchDictsByType',{
                type:'count_unit',
            }).then(
                function(data){
                    console.log(data);
                    var b = data.body.hasErrors;
                    if (!b) {
                        this.countUnitList = data.body.data;
                    }else{
                        errorMessage = data.body.errorMessage;
                        this.$message({ showClose: true, message: errorMessage, type: 'failure', duration:2000 });
                    }
                },
                function(data){
                    this.$message({ showClose: true, message: 'è·å–åŠ¨ä½œé›†åˆå¤±è´¥ï¼', type: 'failure', duration:2000 });
                });

        },
        changeCountDate:function () {
            if (this.form.countUnit == '1day') {
                if (this.form.countDate != '') {
                    this.form.countDate=this.form.countDate.substring(0,11) + '00:00:00';
                } else {
                    var date = new Date();
                    this.form.countDate = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + '00:00:00';
                }
            }
        },
        searchVisitis:function(formName){
            var flag = false;
            this.$refs[formName].validate(
                function (valid){
                    if (valid) {
                        flag = true;
                    } else {
                        return false;
                    }
                });
            if (flag) {
                var loading = this.$loading({
                    lock: true,
                    text: 'æ‹¼å‘½åŠ è½½ä¸­ğŸ˜...',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                Vue.http.options.emulateJSON = false;
                Vue.http.options.headers = {'Content-Type': 'application/json;charset=UTF-8'};
                this.$http.post('/star-web/systemController/getTPCount', {
                    system: this.form.system,
                    activeId: this.form.activeId,
                    countUnit: this.form.countUnit,
                    countDate: this.form.countDate,
                    resqlimit: this.form.resqlimit,
                    source: 'limitCount'
                }).then(
                    function (data) {
                        var b = data.body.hasErrors;
                        if (!b) {
                            var chartdto = data.body.data;
                            var xAxis = this.option.xAxis[0];
                            xAxis['data'] = chartdto.x;
                            var xAxisArray = [];
                            xAxisArray.push(xAxis);
                            this.option.xAxis = xAxisArray;
                            var series = this.option.series[0];
                            series['data'] = chartdto.y1;
                            var series1 = this.option.series[1];
                            series1['data'] = chartdto.y2;
                            var seriesArray = [];
                            seriesArray.push(series);
                            seriesArray.push(series1);
                            this.option.series = seriesArray;
                            this.initEcharts();
                        } else {
                            errorMessage = data.body.errorMessage;
                            this.$message({showClose: true, message: errorMessage, type: 'failure', duration: 2000});
                        }
                        loading.close();
                    },
                    function (data) {
                        loading.close();
                        this.$message({showClose: true, message: 'ç³»ç»Ÿå¼‚å¸¸ï¼', type: 'failure', duration: 2000});
                    });
            }
        },
        initEcharts:function(){
            this.mycharts = echarts.init(document.getElementById('performanceChart'),'macarons');
            // ä½¿ç”¨åˆšæŒ‡å®šçš„é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨ã€‚
            this.mycharts.setOption(this.option);
            window.onresize = this.mycharts.resize;
        },
    },
    mounted:function(){
        this.initEcharts();
        this.getAllSystem();
        this.getCountUnit();
    }
});

